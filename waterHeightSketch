/*
  Sketch generated by the Arduino IoT Cloud Thing "EIoTK_Activity_08"
  https://create.arduino.cc/cloud/things/4c178f1c-a581-49bc-8123-4f6d8f21d4b2
 
  Arduino IoT Cloud Properties description
 
  The following variables are automatically generated and updated when changes are made to the Thing

  float error;
  float height;
  float height_set_point;
  float humidity;
  float temperature;
  CloudColoredLight rgbColor;
  int light;
  int moistValue;
  bool relay_1;
  bool relay_2;
  bool updateDisplay;

  Properties which are marked as READ/WRITE in the Cloud Thing will also have functions
  which are called when their values are changed from the Dashboard.
  These functions are generated with the Thing and added at the end of this sketch.
*/
#include "thingProperties.h"
#include <Arduino_MKRIoTCarrier.h>
MKRIoTCarrier carrier;
 
int moistPin = A5;

bool waterpump = false;
float error_tolerance = 0.25;   // example tolerance

String waterPumpState = "OFF";

String relayState1 = "";
String relayState2 = "";
 
void setup() {
  // Initialize serial and wait for port to open:
  Serial.begin(9600);
  // Defined in thingProperties.h
  initProperties();
  
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);
  
  CARRIER_CASE = false;
  carrier.begin();
  
  setDebugMessageLevel(4);   //Get Cloud Info/errors , 0 (only errors) up to 4
  ArduinoCloud.printDebugInfo();

  
  
  while (ArduinoCloud.connected() != 1) {
    ArduinoCloud.update();
    carrier.display.setTextSize(3);
    carrier.display.setCursor(20, 70);
    carrier.display.println("Waiting For");
    carrier.display.setCursor(5, 110);
    carrier.display.println("Connection...");
    delay(500);
  }
}
 
 
 
void loop() {
  ArduinoCloud.update();
 
  if (relay_1 == true) {
    carrier.Relay1.open();
    relayState1 = "ON";
  }
  else {
    carrier.Relay1.close();
    relayState1 = "OFF";
  }
 
  if (relay_2 == true) {
    carrier.Relay2.open();
    relayState2 = "ON";
  }
  else {
    carrier.Relay2.close();
    relayState2 = "OFF";
  }
 
 
  if (carrier.Light.colorAvailable()) {
    int none;//not gonna be used
    carrier.Light.readColor(none,  none,  none, light);
  }
 
 
  temperature = carrier.Env.readTemperature();
  humidity = carrier.Env.readHumidity();
 
  int rawMoistValue = analogRead(moistPin);
  moistValue = map(rawMoistValue, 700, 1023, 100, 0);

  moistValue = rawMoistValue;
  height = pow(10,(-2.774*log10(rawMoistValue)+8.235));

//____christmas tree lights


  // Calculate control error
error = height_set_point - height;

// main logic for on/off pump control
if (waterpump = false){ //pump is off
  if (error<=-error_tolerance){ //water level exceeds upper limit
    waterpump=true; //pump off, turn on
    carrier.Relay1.open(); //turn on pump
    delay(2000);
  }else{
    waterpump = false; //pump is off, stay off
    carrier.Relay1.close(); //pump stay off
    delay(2000);
    waterPumpState="OFF";
  }
} else{    //pump is ON (waterpump == true
  if (error>=error_tolerance){ //water level drops below lower limit
    waterpump=false; //turn pump off
    carrier.Relay1.close(); //turn off pump
    delay(2000);
    waterPumpState="OFF";
  } else{
    waterpump=true; //pump stay on
    carrier.Relay1.open(); //stay on
    delay(2000);
    waterPumpState="ON";
  }
}  //end if  
  
  
  height = pow(10,(-2.936*log10(rawMoistValue)+8.667));

  if(height >=2.25) { //h20 too heigh
    carrier.leds.setPixelColor(0, 255, 0, 0);
    carrier.leds.setPixelColor(1, 255, 0, 0);
    carrier.leds.setPixelColor(2, 255, 0, 0);
    carrier.leds.setPixelColor(3, 255, 0, 0);
    carrier.leds.setPixelColor(4, 255, 0, 0);
    carrier.Buzzer.sound(500); //Buzzer sound
  } else if (height >=2.0) { //one green
    carrier.leds.setPixelColor(0, 255, 0, 0);
    carrier.leds.setPixelColor(1, 255, 0, 0);
    carrier.leds.setPixelColor(2, 255, 0, 0);
    carrier.leds.setPixelColor(3, 255, 0, 0);
    carrier.leds.setPixelColor(4, 0, 255, 0);
    carrier.Buzzer.noSound(); // no sound
  } else if (height >=1.75) { //two green
    carrier.leds.setPixelColor(0, 255, 0, 0);
    carrier.leds.setPixelColor(1, 255, 0, 0);
    carrier.leds.setPixelColor(2, 255, 0, 0);
    carrier.leds.setPixelColor(3, 0, 255, 0);
    carrier.leds.setPixelColor(4, 0, 255, 0);
    carrier.Buzzer.noSound(); // no sound
  } else if (height >=1.5) { //three green
    carrier.leds.setPixelColor(0, 255, 0, 0);
    carrier.leds.setPixelColor(1, 255, 0, 0);
    carrier.leds.setPixelColor(2, 0, 255, 0);
    carrier.leds.setPixelColor(3, 0, 255, 0);
    carrier.leds.setPixelColor(4, 0, 255, 0);
    carrier.Buzzer.noSound(); // no sound
  } else if (height >=1.25) { //four green
    carrier.leds.setPixelColor(0, 255, 0, 0);
    carrier.leds.setPixelColor(1, 0, 255, 0);
    carrier.leds.setPixelColor(2, 0, 255, 0);
    carrier.leds.setPixelColor(3, 0, 255, 0);
    carrier.leds.setPixelColor(4, 0, 255, 0);
    carrier.Buzzer.noSound(); // no sound
  } else { //all green
    carrier.leds.setPixelColor(0, 0, 255, 0);
    carrier.leds.setPixelColor(1, 0, 255, 0);
    carrier.leds.setPixelColor(2, 0, 255, 0);
    carrier.leds.setPixelColor(3, 0, 255, 0);
    carrier.leds.setPixelColor(4, 0, 255, 0);
    carrier.Buzzer.noSound(); // no sound
  }
    carrier.leds.show(); // update the pixels
  }
 
 
 
 
void onRelay1Change() {
  // Do something  
}
 
void onRelay2Change() {
  // Do something
}
 
void onRgbColorChange() {
  // Do something
  uint8_t r, g, b;
  rgbColor.getValue().getRGB(r, g, b);
  if (rgbColor.getSwitch()) {
    carrier.leds.fill(carrier.leds.Color(g, r, b), 0, 5);
    carrier.leds.show();
  }
  else {
    carrier.leds.fill(0, 0, 5);
    carrier.leds.show();
  }
}
 
void onUpdateDisplayChange() {
  // Do something
  carrier.display.fillScreen(ST77XX_WHITE);
  carrier.display.setTextColor(ST77XX_RED);
  carrier.display.setTextSize(2);
 
  carrier.display.setCursor(20, 30);
  carrier.display.print("Temp: ");
  carrier.display.print(temperature);
  carrier.display.print(" C");
 
  carrier.display.setCursor(20, 50);
  carrier.display.print("Humi: ");
  carrier.display.print(humidity);
  carrier.display.print(" %");
 
  carrier.display.setTextColor(ST77XX_ORANGE);
  carrier.display.setCursor(20, 70);
  carrier.display.print("Light: ");
  carrier.display.print(light);
 
  carrier.display.setTextColor(ST77XX_BLUE);
  carrier.display.setCursor(20, 90);
  carrier.display.print("Moist: ");
  carrier.display.print(moistValue);
  carrier.display.print(" %");
 
  carrier.display.setTextColor(ST77XX_BLUE);
  carrier.display.setCursor(20, 120);
  carrier.display.print("R1: ");
  carrier.display.print(relayState1);
 
  carrier.display.print(" R2: ");
  carrier.display.print(relayState2);
 
  updateDisplay = false;
}


/*
  Since HeightSetPoint is READ_WRITE variable, onHeightSetPointChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onHeightSetPointChange()  {
  // Add your code here to act upon HeightSetPoint change
}

/*
  Since Error is READ_WRITE variable, onErrorChange() is
  executed every time a new value is received from IoT Cloud.
*/
void onErrorChange()  {
  // Add your code here to act upon Error change
}
